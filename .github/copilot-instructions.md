# Copilot Instructions for this repository

## Quick summary ‚úÖ
- This repo manages AWS infrastructure using **Terraform** and provisioning helpers with **Ansible**. Primary components live under `01-vpc/` (VPC, subnets) and `02-securitygroups/` (security groups and rules). Tooling and provisioning helpers live in `002-tools_install/` and CI workflows in `.github/workflows/`.

## Architecture & important files üîß
- Terraform structure:
  - `01-vpc/` ‚Äî VPC, subnets, backend config per environment (dev/qa/prod)
  - `02-securitygroups/` ‚Äî security groups module usage and SSM parameters
  - `terraform/` and `modules/` ‚Äî shared modules and top-level orchestration
  - Module sources are remote (e.g., `git::https://github.com/Iam-naresh-devops/terraform-aws-vpc.git` and `git::https://github.com/Iam-naresh-devops/SG_module.git`).
- CI & orchestration:
  - GitHub Actions: `.github/workflows/aws-terraform-deploy.yaml`, `terraform-sg.yaml`, `terraform-tool-setup.yaml` (manual input workflows; use workflow inputs like `TERRAFORM_ACTION` / `Terraform_Environment`).
  - Jenkins: `Jenkinsfile`, `Jenkinsfile-d`, and `002-tools_install/cm.Jenkinsfile` contain alternative pipeline logic (manual approvals in DB stages).
- Ansible: `002-tools_install/ansible/` and `ansible-ssm/` use **aws_ssm** transport; see `ansible.cfg` for `aws_ssm` and `group_vars/all.yaml` for bucket/region overrides.

## Patterns & conventions to follow üìã
- Environment-driven state keys: Terraform backends use keys like `vpc/<env>/terraform.tfstate` and `sg/<env>/terraform.tfstate`. Always use the correct `-backend-config="key=..."` when initializing.
- SSM parameter usage: Many resources (SG IDs, subnet IDs) are stored/retrieved via AWS SSM Parameter Store (see `01-vpc/parameters.tf` and `02-securitygroups/parameters.tf`). Treat these parameter names as stable references.
- Module-first approach: The repo relies on remote module sources. Changes to modules may require `terraform init -upgrade` or clearing `.terraform` before reinit.
- Conditional rules: Security rules often allow `cidr_blocks = null` meaning a rule is conditionally omitted or populated via `locals.tf` defaults ‚Äî inspect `02-securitygroups/locals.tf` for templates.

## Common workflows & explicit commands (copy-paste) üß≠
- Initialize VPC (example for `qa`):
  - cd `01-vpc`
  - terraform init -backend-config="key=vpc/qa/terraform.tfstate" -reconfigure
  - terraform plan -var="environment=qa"
  - terraform apply -var="environment=qa" -auto-approve

- Initialize Security Groups (example for `qa`):
  - cd `02-securitygroups`
  - terraform init -backend-config="key=sg/qa/terraform.tfstate" -reconfigure
  - terraform plan -var="environment=qa"
  - terraform apply -var="environment=qa" -auto-approve

- Run Ansible playbook using SSM transport (local check):
  - cd `002-tools_install/ansible`
  - ansible-playbook -i inventory/ssm_hosts.ini playbook.yaml
  - Ensure `group_vars/all.yaml` has `ansible_aws_ssm_bucket_name` and `ansible_aws_ssm_region` if needed.

- Use GitHub Actions manually via the repository's "Actions" UI (workflows accept inputs):
  - `aws-terraform-deploy.yaml` expects inputs `TERRAFORM_ACTION` (deploy/destroy) and `Terraform_Environment` (dev/qa/prod).
  - `terraform-sg.yaml` expects input `TERRAFORM_ACTION` (creation/deletion).

## Important safety notes ‚ö†Ô∏è
- Order matters: VPC must exist before Security Groups that reference VPC/subnet SSM parameters. Running SG apply without VPC state/SSM parameters will fail.
- Do not rename SSM parameter keys lightly ‚Äî other terraform modules read them by name.
- Workflows and Jenkinsfiles sometimes run `terraform init -reconfigure` and `terraform apply -auto-approve` ‚Äî treat remote workflows as the canonical automation and mirror their exact backend key usage locally.

## Where to look for changes or causes of failures üîé
- Backend and environment mismatches: `provider.tf` and `*/backend.tf` files in each component.
- Missing SSM params: `02-securitygroups/data.tf` reads many SSM params; check `01-vpc/parameters.tf` to confirm they were created.
- Module updates: `locals.tf` and `main.tf` in `02-securitygroups` show where rules are assembled and passed to modules.

## Examples of repository-specific code patterns to reference
- `02-securitygroups/main.tf` uses `for_each` to assemble and call a remote module per SG.
- `02-securitygroups/locals.tf` contains a long library of rule templates and many `cidr_blocks = null` placeholders ‚Äî inspect this file when composing or troubleshooting ingress rules.

---
If anything above is unclear or you'd like more details (for example: conventions for tags, naming, or how to add a new security group template), tell me which area and I will expand the file with concrete examples. ‚úÖ

(Generated by an automated assistant ‚Äî please review for accuracy before running destructive commands.)